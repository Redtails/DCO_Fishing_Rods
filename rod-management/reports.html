<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports</title>
  <style>
    /* Use default system fonts */
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 40px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <h1>üìù Reports Dashboard</h1>

  <section>
    <h2>Defect Entries</h2>
    <table id="defect-table">
      <thead>
        <tr>
          <th>Batch ID</th>
          <th>Type</th>
          <th>Shift</th>
          <th>Technician</th>
          <th>Notes</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2>Inventory Updates</h2>
    <table id="inventory-table">
      <thead>
        <tr>
          <th>Item ID</th>
          <th>Quantity</th>
          <th>Reason Code</th>
          <th>Staff ID</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2>Inspection Reports</h2>
    <table id="inspection-table">
      <thead>
        <tr>
          <th>Batch ID</th>
          <th>Shift</th>
          <th>Inspector ID</th>
          <th>Findings</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2>Maintenance Requests</h2>
    <table id="maintenance-table">
      <thead>
        <tr>
          <th>Equipment ID</th>
          <th>Description</th>
          <th>Requested By</th>
          <th>Status</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h2>Calibration Logs</h2>
    <table id="calibration-table">
      <thead>
        <tr>
          <th>Equipment ID</th>
          <th>Calibration Date</th>
          <th>Calibrated By</th>
          <th>Next Due Date</th>
          <th>Notes</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    console.log('Reports script loaded');

    // Generic loader
    async function loadData(endpoint, tableId, mapper) {
      try {
        const res = await fetch(`/api/${endpoint}`);
        if (!res.ok) throw new Error(`Fetch ${endpoint} failed: ${res.status}`);
        const data = await res.json();
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = '';
        data.forEach(item => {
          const row = document.createElement('tr');
          mapper(item, row);
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error(err);
        const section = document.getElementById(tableId);
        section.insertAdjacentHTML('afterend', `<p style="color:red;">Error loading ${endpoint}</p>`);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadData('defect-entry', 'defect-table', (item, tr) => {
        tr.innerHTML = `
          <td>${item.batch_id}</td>
          <td>${item.defect_type}</td>
          <td>${item.shift}</td>
          <td>${item.technician_id}</td>
          <td>${item.notes}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
      });
      loadData('inventory-update', 'inventory-table', (item, tr) => {
        tr.innerHTML = `
          <td>${item.item_id}</td>
          <td>${item.quantity}</td>
          <td>${item.reason_code}</td>
          <td>${item.staff_id}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
      });
      loadData('inspection-report', 'inspection-table', (item, tr) => {
        tr.innerHTML = `
          <td>${item.batch_id}</td>
          <td>${item.shift}</td>
          <td>${item.inspector_id}</td>
          <td>${item.findings}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
      });
      loadData('maintenance-request', 'maintenance-table', (item, tr) => {
        tr.innerHTML = `
          <td>${item.equipment_id}</td>
          <td>${item.issue_description}</td>
          <td>${item.requested_by}</td>
          <td>${item.status || 'Pending'}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
      });
      loadData('calibration-log', 'calibration-table', (item, tr) => {
        tr.innerHTML = `
          <td>${item.equipment_id}</td>
          <td>${new Date(item.calibration_date).toLocaleDateString()}</td>
          <td>${item.calibrated_by}</td>
          <td>${item.next_due_date}</td>
          <td>${item.notes}</td>
          <td>${new Date(item.timestamp).toLocaleString()}</td>
        `;
      });
    });
  </script>
</body>
</html>

